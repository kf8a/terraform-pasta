---
# pasta
- hosts: pasta-build
  vars:
    packages:
      - AuditManager
      - DataPackageManager
      - DataPortal
      - DataPortal2
      - dataserver
      - EventManager
      - Gatekeeper

  tasks:
  - name: upgrade apt-cache
    apt: update_cache=yes cache_valid_time=3600

  - name: ensure that the system is up to date
    apt: upgrade=dist

  - name: ensure that postgresql is installed and at the latest version
    apt: pkg=postgresql state=installed

  - name: jdk is installed
    apt: pkg=openjdk-7-jdk state=installed

  - apt: pkg=subversion state=installed
  - apt: pkg=git state=installed
  - apt: pkg=ant state=installed
  - apt: pkg=tomcat8 state=installed

  - name: check out data manager library
    subversion: repo=https://code.ecoinformatics.org/code/eml/trunk/ dest=eml

  - name: check out PASTA
    git: repo=https://github.com/lter/PASTA.git dest=PASTA

  - command: ant jar-datamanager-lib
    args: 
      chdir: ./eml
      creates: ./build/datamanager.jar

  - command: cp ./eml/build/datamanager.jar ./PASTA/lib/datamanager/

  - command: cp build.properties.template build.properties
    args:
      chdir: ./PASTA/{{ item }}
    with_items: packages

  - lineinfile: dest=./PASTA/{{ item }}/build.properties regexp=^tomcat.lib= line=tomcat.lib=/usr/share/tomcat8/lib
    with_items: packages

  - command: ant 
    args:
      chdir: ./PASTA/{{ item }}
    with_items: packages

